{"expireTime":9007200812251251000,"key":"transformer-remark-markdown-html-402fae099ac1890692ee02130a70594a-gatsby-remark-code-titlesgatsby-remark-embed-youtubegatsby-remark-imagesgatsby-remark-responsive-iframegatsby-remark-custom-blocksgatsby-remark-prismjsgatsby-remark-copy-linked-filesgatsby-remark-smartypants-","val":"<h2>什么是监控系统？</h2>\n<p>从技术的角度来说，监控系统是一个管理和记录IT系统运行状况的工具，但是监控系统做的远不止这些，它可以把程序出现的问题在用户或客户发现之前， 提前把消息通过邮件或者短信的方式告诉运维人员，可以根据预设的阈值去触发相应的处理流程，也可以把收集到的信息通过用户友好的方式展现出来.</p>\n<h2>为什么使用riemann？</h2>\n<ul>\n<li>功能强大，支持多种语言客户端连接，并且提供的大量可插拔使用的插件。</li>\n<li>轻量级，架构非常灵活，模块之间耦合低，可以任意替换其中某个模块到适合自己的实现方案。</li>\n<li>系统配置使用clojure，一个跑在jvm上的lisp方言，clojure的表达能力强，事件的过滤和处理简练方便。</li>\n</ul>\n<h2>系统依赖 :</h2>\n<ul>\n<li>java</li>\n<li>ruby>2.0</li>\n</ul>\n<h2>安装并启动:</h2>\n<p>riemann 提供了 deb rpm 源码包三种不同的类型供选择，选择适合自己的包下载安装就可以了。我这里使用的是mac，在mac上可以直接使用 brew 来安装：</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">brew <span class=\"token function\">install</span> riemann</code></pre></div>\n<p>riemann 安装完成后下面安装 riemann-dash和riemann-tools， riemann-dash 是一个基于ruby sintra的一个web应用，它提供了一个简单的 dashboard。riemann-tools 是一系列监控插件的集合。这两都是基于ruby，下面使用 gem 来安装：</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">gem <span class=\"token function\">install</span> riemann-dash riemann-tools -V</code></pre></div>\n<p>很简单，安装完成后，下面修改下riemann的配置文件：</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">cp</span> /usr/local/etc/riemann.config.guide riemann.config\n<span class=\"token function\">vi</span> /usr/local/etc/riemann.config</code></pre></div>\n<p>然后把配置文件的内容修改成这样：</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token punctuation\">;</span> -*- mode: clojure<span class=\"token punctuation\">;</span> -*-\n<span class=\"token punctuation\">;</span> vim: filetype<span class=\"token operator\">=</span>clojure\n\n<span class=\"token punctuation\">(</span>logging/init <span class=\"token punctuation\">{</span>:file <span class=\"token string\">\"/var/log/riemann.log\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token punctuation\">;</span> Listen on the local interface over TCP <span class=\"token punctuation\">(</span>5555<span class=\"token punctuation\">)</span>, UDP <span class=\"token punctuation\">(</span>5555<span class=\"token punctuation\">)</span>, and websockets\n<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">(</span>5556<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">(</span>let <span class=\"token punctuation\">[</span>host <span class=\"token string\">\"0.0.0.0\"</span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">(</span>tcp-server <span class=\"token punctuation\">{</span>:host host<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span>udp-server <span class=\"token punctuation\">{</span>:host host<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">(</span>ws-server <span class=\"token punctuation\">{</span>:host host<span class=\"token punctuation\">}</span><span class=\"token punctuation\">))</span>\n\n<span class=\"token punctuation\">;</span> Expire old events from the index every 5 seconds.\n<span class=\"token punctuation\">(</span>periodically-expire 5<span class=\"token punctuation\">)</span>\n\n<span class=\"token punctuation\">(</span>let <span class=\"token punctuation\">[</span>index <span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">(</span>streams\n    <span class=\"token punctuation\">(</span>default :ttl 60\n      index\n      <span class=\"token comment\">#(info %))))</span></code></pre></div>\n<p>上面配置修改了host地址，日志文件，和写入日志的类型。 修改完了riemann 的配置下面修改 riemnan-dash 的配置：</p>\n<p>vi /usr/local/etc/riemann.dash.rb</p>\n<p>写入下面的内容：</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token keyword\">set</span> :port, 4567      <span class=\"token comment\"># HTTP server on port 4567</span>\n<span class=\"token keyword\">set</span> :bind, <span class=\"token string\">\"0.0.0.0\"</span> <span class=\"token comment\"># Bind to a different interface</span>\nconfig<span class=\"token punctuation\">[</span>:ws_config<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'custom/config.json'</span> <span class=\"token comment\"># Specify custom workspace config</span></code></pre></div>\n<h3>启动riemann：</h3>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">riemann /usr/local/etc/riemann.config</code></pre></div>\n<h3>启动riemann-dash：</h3>\n<p>riemann-dash /usr/local/etc/riemann.dash.rb</p>\n<p>启动之后打开浏览器访问： <a href=\"http://127.0.0.1:4567/\">http://127.0.0.1:4567/</a> 可以看到下面的界面</p>\n<p>\n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 700px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABtUlEQVQoz6VQyarqUBDMv7rwE1yKoDiAIOjejTsXorjR55REjTHOiLpwNolDRJEHoijWs/sS8N67fA3FOd1NV3eVcDqd8Hq9YMfj8fiF5/P5Lb/f7zifz7hcLtA3G+wPFv5ebzBNE8JoNEKxWMRiscDhcMD/xO12g+D3++Hz+RAKhVAoFJBOp5HJZHhJPB5HIpHAcDhEKpXifjKZRDabRS6X4z4ptON6vULweDyIxWIgYq/XC6fTCbfbDapHIhEEg0FeSDWHw4FoNIpAIACXy4VwOIxarcZkZBsTDgYD9qXVamE8HqPRaEBraZhOp2zDfD6HpmnI5//w8HK5xGQyQb/f596nTSx5tVox0Xq9hmEY2G63MI0tDN2Arm+w2ZjY7y0cj0dYlsX93W73ru35r+s6Lyae2WwGgbwiP/L5PHskSRLkSg2yJL8vqkIU66jXVahqg69XVfUbms0mKyB0Oh0I1WoVpVIJlUoFsizzWy5/5aIovUkUtuMnbJJPkA0C+VIul9/DIoNyRVGg1BUma7fb6Ha7vP3zJe9/otfrQSCJRGhfSfmnHPtPcm1QTsQ2aAGREf4BIEiutly0jm8AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"gif\"\n        title=\"\"\n        src=\"/static/6a7ca4d228ae7f1e126c96029b3a85f9/a8200/riemann-dash-init.png\"\n        srcset=\"/static/6a7ca4d228ae7f1e126c96029b3a85f9/52d5c/riemann-dash-init.png 175w,\n/static/6a7ca4d228ae7f1e126c96029b3a85f9/1bae2/riemann-dash-init.png 350w,\n/static/6a7ca4d228ae7f1e126c96029b3a85f9/a8200/riemann-dash-init.png 700w,\n/static/6a7ca4d228ae7f1e126c96029b3a85f9/0ab52/riemann-dash-init.png 1050w,\n/static/6a7ca4d228ae7f1e126c96029b3a85f9/fa92b/riemann-dash-init.png 1400w,\n/static/6a7ca4d228ae7f1e126c96029b3a85f9/44231/riemann-dash-init.png 2100w,\n/static/6a7ca4d228ae7f1e126c96029b3a85f9/31522/riemann-dash-init.png 2556w\"\n        sizes=\"(max-width: 700px) 100vw, 700px\"\n      />\n    </span>\n  </span>\n  </p>\n<p>现在界面出来了，但是是空的，现在需要把监控数据传给riemann，然后在dashboard上展示出来，在配置展示页面之前开启一个汇报程序 riemann-health，这个程序会把系统的信息汇报给riemann，然后就可以配置dashboard，展示这些数据了。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">riemann-health</code></pre></div>\n<h3>可以在riemann的log里面看到日志：</h3>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">INFO \\<span class=\"token punctuation\">[</span>2016-09-10 22:46:32,539\\<span class=\"token punctuation\">]</span> Thread-4 - riemann.config - <span class=\"token comment\">#riemann.codec.Event{:host localhost, :service riemann server tcp 0.0.0.0:5555 in latency 0.5, :state ok, :description nil, :metric 635377/500000, :tags nil, :time 294703758507/200, :ttl 20}</span>\nINFO \\<span class=\"token punctuation\">[</span>2016-09-10 22:46:32,540\\<span class=\"token punctuation\">]</span> Thread-4 - riemann.config - <span class=\"token comment\">#riemann.codec.Event{:host localhost, :service riemann server tcp 0.0.0.0:5555 in latency 0.95, :state ok, :description nil, :metric 1343/800, :tags nil, :time 294703758507/200, :ttl 20}</span>\nINFO \\<span class=\"token punctuation\">[</span>2016-09-10 22:46:32,540\\<span class=\"token punctuation\">]</span> Thread-4 - riemann.config - <span class=\"token comment\">#riemann.codec.Event{:host localhost, :service riemann server tcp 0.0.0.0:5555 in latency 0.99, :state ok, :description nil, :metric 1343/800, :tags nil, :time 294703758507/200, :ttl 20}</span>\nINFO \\<span class=\"token punctuation\">[</span>2016-09-10 22:46:32,540\\<span class=\"token punctuation\">]</span> Thread-4 - riemann.config - <span class=\"token comment\">#riemann.codec.Event{:host localhost, :service riemann server tcp 0.0.0.0:5555 in latency 0.999, :state ok, :description nil, :metric 1343/800, :tags nil, :time 294703758507/200, :ttl 20}</span>\nINFO \\<span class=\"token punctuation\">[</span>2016-09-10 22:46:32,541\\<span class=\"token punctuation\">]</span> Thread-4 - riemann.config - <span class=\"token comment\">#riemann.codec.Event{:host localhost, :service riemann server udp 0.0.0.0:5555 in rate, :state ok, :description nil, :metric 0.0, :tags nil, :time 294703758507/200, :ttl 20}</span></code></pre></div>\n<p>这些就是riemann-health 发给riemann的数据。下面该配置dashboard了，现在回到web界面，然后根据提示，选择当前操作系统对应的快捷键 比如在mac上就是 按下 option + command 同时点击页面，看到阴影后，按 e 键，可以看到一个弹出框：</p>\n<p>\n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 700px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 50.77452667814113%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABvElEQVQoz3WRSWuaYRSFv7/iyoULZ0UcUNSVI6IujOKsOI+gm/QXCAmoCC78XaWUZmUptUqSjUmrnuZcYjAdLjy8vHznnvfe8yn5fB6FQgE8c7mckM1mkUwmkSCJBOLx+DvS6TRSqRQymYzoyFU6I3fFYrHA4/HA6/UiEokgFApJ02Qywe3NDabTKWaz2Rvz+RzFYhHBYBDRaFQIh8MvhKRX0el0IE6nEw6HAwaDQQRf7u7w9dt3nE74q0ajkehMJhN8Ph9isRgir+aK0WiEXq+HVquFWq2GRqMR44+fPuPH4zN+/jrgeDjg8AqLEalUKlitVnBDxsLtxDAQCMBms8HlcsFut8NsNsuEDw/30nx6GfESVq/Xkwn9fj/cbreYMQJZmT+hVCqhXC6jUqnI691uF09Pz2+Gl8Ys5sofQD37mOkZpd1uo9PpiMlgMEC308f19Qfs93tpPh6PYsSTsFarlfSMx2PJ8xKlVquhXq+j2Wyi1WqBd3445/WvWi6XqFarsjqNCQfjXWk0GriEhsPhEOv1GtvtFpvN5h273Q6LxUIep45bkX6/L6fC6QjNKOJLhIL/cY6Hhn/yG/qF/+AgU7W+AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"gif\"\n        title=\"\"\n        src=\"/static/3aec22b5208e66c357ccce594456633b/a8200/riemann-dash-init-edit.png\"\n        srcset=\"/static/3aec22b5208e66c357ccce594456633b/52d5c/riemann-dash-init-edit.png 175w,\n/static/3aec22b5208e66c357ccce594456633b/1bae2/riemann-dash-init-edit.png 350w,\n/static/3aec22b5208e66c357ccce594456633b/a8200/riemann-dash-init-edit.png 700w,\n/static/3aec22b5208e66c357ccce594456633b/0ab52/riemann-dash-init-edit.png 1050w,\n/static/3aec22b5208e66c357ccce594456633b/fa92b/riemann-dash-init-edit.png 1400w,\n/static/3aec22b5208e66c357ccce594456633b/44231/riemann-dash-init-edit.png 2100w,\n/static/3aec22b5208e66c357ccce594456633b/7a1d1/riemann-dash-init-edit.png 2324w\"\n        sizes=\"(max-width: 700px) 100vw, 700px\"\n      />\n    </span>\n  </span>\n  </p>\n<p>然后选择下拉列表中的一个，比如 flot，在 query 中写 true。然后点击apply</p>\n<p>\n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 700px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 85.5098389982111%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAABYlAAAWJQFJUiTwAAACXUlEQVQ4y51TTU8aURTlzwmRLwkLFqYqCeWrEAKBworAlgULY/wLbPQ/dNngooB8CUEKAUT5HKqWwDBzOvdSBJRY0xfO3Pce954597w3KqPRiIODA1DU6/XQarXQ6XQMWhsMhpe4wuaa5lRrNps5qoiMNi0WC66urlCv11Eul1GpVFAsFpHNZpHL5XaC/svn81zncrlYBBOSKqvVimwmg3Q6rZDdcLIgCPjoiEQiUKvVa8Lj42Pkrq/xI5NF/WcTuXwB9w8PnLwQRSwWiw1IkCSJ56u4RUhSj44+4bZ5h/HjFP0nGaXhe3pkyLLypAeW8Q0hKSQ/CoUCqtUqRqMRbu6e0e4+YDDoY6isfz/9Qns0w+B5SSq9ItRoNOuWT05O2DcyuFarodW4xbdCD9+rIzwKQ4VwjMeJgHthBmG6UrlDoclkYoVESOq63S77Iopzxbs5ZqLEBeyVAkii8lP253PM5zMFynw2QzgcXirc39/nyeHhITqdDheu3soCZPnvfBPbCqnG7/djb28PKrfbDafTyW8Yj8cvCS/F7x3NBmEikYDdbocqFPqKgD+AaDS6897JOxWuQUNUrtXp6Sl8Ph9UXxw+OGxuhCNhNBoN9rDZbKLVamE4HHIyeUQgv2i9CbqDtE+EXq+XFAa5/3g8jlKphF6vh8lkwphOp1yweZq7WqZxdna2JCQPbbbPfOz0Dbfb7a2C14S7WqaYTCaXHno8Hj6UYDCIfr/PysQ3n9q/QS0TFyt0OBwIBALsxf+O8/PzZctERB6GQiGkUilcXl7i4uLiw1jlx2Ix5vkDalFmgSaXaLkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"gif\"\n        title=\"\"\n        src=\"/static/9d0be1ca6464a039688919891fa179b8/a8200/riemann-dash-init-edit-flot.png\"\n        srcset=\"/static/9d0be1ca6464a039688919891fa179b8/52d5c/riemann-dash-init-edit-flot.png 175w,\n/static/9d0be1ca6464a039688919891fa179b8/1bae2/riemann-dash-init-edit-flot.png 350w,\n/static/9d0be1ca6464a039688919891fa179b8/a8200/riemann-dash-init-edit-flot.png 700w,\n/static/9d0be1ca6464a039688919891fa179b8/0ab52/riemann-dash-init-edit-flot.png 1050w,\n/static/9d0be1ca6464a039688919891fa179b8/b1b29/riemann-dash-init-edit-flot.png 1118w\"\n        sizes=\"(max-width: 700px) 100vw, 700px\"\n      />\n    </span>\n  </span>\n  </p>\n<p>下面的help text 也可以照上面的方法如法炮制, 这次可以不选flot，可以选择其他的选项比如log，编辑完成后按 s 键保存配置，下次打开的时候，还是配置过的界面。</p>\n<p>\n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 700px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 49.49099451840251%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAACZklEQVQoz02Q2U9TQRSH759oIlEDSgggIQHDC7JpF7YHY7FgSxUQhUILsoj4IsiSoFEEaaHFhoJQSkt3oeXB0vbe28+hQvAk3/2dM3PmN2eu5HJtEQqFuAhVVcnn8+TVvMivVf2vLqwpKsnTFGepM8KhMNFIjNPUH9Lpc6RENEwqleQqLgzlrEIuo3Celgt6ReZcFigFlBzksqJXBlnkykWeU5Gi4QiBoyNhmiqQzWYRc6DIKpm0OJhXLidXySky2dy/S7JZuVDnhLksVFZEr1ApFo1weHhIIBjEJzQSjV4+X0yQERNzHapy8bkqxJ6YTpHzhfX85ZaUPIniO9gnGAjgF4YxYZiMxQn79on4ffwW/+ckERcaJxYIEg/6SBz7OQ0FiB/5BL+ICU34/ZzFE0ij/ZMMmsYYskwItWPtm2JY5FbLNCtTXXgWdTjndGwv6HF+1LA595jdxSbWlnoYeTfN+Kzgwwz2mWnGZt8jmV7aMDx/zTPzMEazFUPPa7pMQ3T12phvr2fz4U0cjbfYFDgbb7PRfAdPfRHfXtRhXTFiWzYw/tnI2y9Gpla7kexLAwzNmxlZtGD91It1wSIa+plcH2RE28Kbompsd2uxF9cUmCipZfJGDcvddfwMNrG938DucSN7kRa8oWakla1WlhyP+LqjZf1Az/c9HT8OWvEkOhgw6Wkq1aCp1qGp0qGr0tMm0JZ2MGpswL1ehmu1EvdaBTuOCrzO+0he9wM8znJ2XeXsbJXj3qhg21GJ11XG+HAnndoBnrZbeNLaKzBjaBfa9ooxQxtr5mJWTSWsCzZ6i3H03eMvKnOdSz9/9nkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"gif\"\n        title=\"\"\n        src=\"/static/1ca638ee9d337ceb454b56d650d3560d/a8200/riemann-dash.png\"\n        srcset=\"/static/1ca638ee9d337ceb454b56d650d3560d/52d5c/riemann-dash.png 175w,\n/static/1ca638ee9d337ceb454b56d650d3560d/1bae2/riemann-dash.png 350w,\n/static/1ca638ee9d337ceb454b56d650d3560d/a8200/riemann-dash.png 700w,\n/static/1ca638ee9d337ceb454b56d650d3560d/0ab52/riemann-dash.png 1050w,\n/static/1ca638ee9d337ceb454b56d650d3560d/fa92b/riemann-dash.png 1400w,\n/static/1ca638ee9d337ceb454b56d650d3560d/44231/riemann-dash.png 2100w,\n/static/1ca638ee9d337ceb454b56d650d3560d/07cba/riemann-dash.png 2554w\"\n        sizes=\"(max-width: 700px) 100vw, 700px\"\n      />\n    </span>\n  </span>\n  </p>"}